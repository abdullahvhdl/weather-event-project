package com.test.weatherproject.schedule;

import com.jayway.jsonpath.DocumentContext;
import com.jayway.jsonpath.JsonPath;
import com.test.weatherproject.domain.Event;
import com.test.weatherproject.service.EventService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
//import org.springframework.data.web.JsonPath;
import org.springframework.http.*;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.net.URISyntaxException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Random;
import java.util.concurrent.ThreadLocalRandom;

@Component
public class EventScheduler {

    private static final Logger log = LoggerFactory.getLogger(EventScheduler.class);

    // private static final SimpleDateFormat dateFormat = new SimpleDateFormat("HH:mm:ss");

    private EventService eventService;

    @Autowired
    public EventScheduler(EventService eventService) {
        this.eventService = eventService;
    }

    //@Scheduled(fixedRate = 2000)
    public void persistWeatherInformation() throws URISyntaxException {

        String json = getExternalWeatherData();
        Event event = convertJsonDataIntoEventObject(json);

        eventService.add(event);
        log.info(event.toString());
    }

    private Event convertJsonDataIntoEventObject(String json) {
        DocumentContext jsonContext = JsonPath.parse(json);
        Event event = new Event();

        try {
            Double latitude = jsonContext.read("$['coord']['lat']");
            event.setLatitude(latitude);
        } catch (ClassCastException e) {
            Integer latitudeInt = jsonContext.read("$['coord']['lat']");
            event.setLatitude((double)latitudeInt);
        }

        try {
            Double longitude = jsonContext.read("$['coord']['lon']");
            event.setLongitude(longitude);
        } catch (ClassCastException e) {
            Integer longitudeInt = jsonContext.read("$['coord']['lon']");
            event.setLongitude((double)longitudeInt);
        }

        Integer timeStamp = jsonContext.read("$['dt']");
        event.setDate(new Date(timeStamp * 1000L));
        event.setLocation(jsonContext.read("$['name']"));
        event.setAlert(jsonContext.read("$['weather'][0]['description']"));
        return event;
    }

    private String getExternalWeatherData() {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        RestTemplate restTemplate = new RestTemplate();
        String apiKey = "88939d83390aa6b5998cf0ada758a1bb";

        int[] cityCodes = {1283378,1271231,2638976,2922336,3496831,1257986,6255149,3575514,1861387,1857578,1299298,2861876,4344544,4673179,1938756,2224928,6716279,2384618,6199126,6388445,1784658,1348747,6255148,5493998,1463749,2653753,2744819,2181258,1862845,1852699,1853163,1864427,1861816,1857451,2128894,3175936,6539582,6542288,3333225,7291924,2648355,3746183,3579132,5815135,5391891,3719432,3428577,2784549,2354349,2311968,2312249,6295429,6291739,6295642,2221394,6547426,2835344,6557629,6553128,6556314,6553174,6555618,2957818,3221125,2949188,6555717,6552854,6557561,6543938,2618525,3495858,3496332,2476412,2479183,2482939,2483761,2498775,6359459,6358465,6362958,6356273,6359334,6533993,6356141,6361741,6362379,6362372,6359273,6359266,6356985,3128528,6357735,6441676,6438569,6446231,6453748,6446218,6457368,6425695,6438526,6446342,6438498,6451981,6455342,6454369,6454153,6454341,6446184,6443784,6441724,6446721,6446177,6453858,6457185,6432528,6446146,6446274,6454157,6451993,6433192,6441821,6455339,6453697,6428545,6618272,6439436,6455331,6613166,6448311,6455394,7292818,3333222,7299965,2634551,3333211,7291961,7291795,7294483,7295275,7297739,7294693,7292284,7294581,2657122,2641519,7298888,7293862,7293814,3333218,7295996,3333227,3333226,7299757,7291323,7296623,7296192,3333142,7291971,7299112,7296198,7291483,7299866,7298694,7296167,2641376,7292321,2294938,2295385,2295672,2416443,8133766,3426466,3589799,3595722,3716661,1213547,1252738,1252744,1252773,6537557,6539485,6536957,6537567,6538821,6541936,6537554,6541484,6541474,6541164,6537588,6541853,6538453,6541136,6539925,6538144,6542123,6541492,6541135,6536221,3489227,3489297,1859472,2751688,2753467,2753718,2754696,2759874,6453374,6453355,6453341,1282635,7531696,7532652,4151245,4155535,4158449,4255818,4287837,7198188,4372589,4422178,4431425,4481511,4527624,4534444,4592843,4735729,4697444,4752215,4753684,4755298,4763237,4764849,4771426,4776242,4778642,4781756,4782241,4787467,4792534,4794134,4899519,4898722,5128316,6941775,5113792,5112738,5118116,5122534,6332485,5133668,5151896,5145576,5153362,5391997,5423573,5525886,1512838,1512978,1513245,1513655,1513957,1514215,1514387,1514396,1526979,3748724,3649281,3625123,3625547,3628416,3645361,3628494,8129175,8129237,3631741,8129172,3633677,8129149,3635325,3637623,8129268,8131449,8131484,3625122,8131393,3642833,8129178,8131442,1559969,1568758,6165683,6111881,3982729,2842569,2826166,2941283,2911739,2865825,6555433,2823141,2821254,2888846,6553115,2928927,2751791,2754273,7874246,2658457,3866425,1185111,2787891,2353169,2355248,2354771,2391377,2395261,3385122,3386567,3387266,3447473,3874943,3879123,2228675,2491335,2492345,2498752,6434715,6434515,6455259,6439779,2994149,6453527,6457117,6457183,6451968,1214189,1214191,1215199,1621613,1621659,1622636,1624545,1632276,1632566,1632694,1632937,1633182,1638775,1638981,1639337,1639356,1642628,1643981,1646448,1647936,1648266,1648451,1648759,1252925,1252946,1253132,1253133,1253219,1253357,1253671,1253698,1253736,1253744,1253747,1253786,1254282,1254317,1254335,1254727,1254732,1254794,1254797,1254868,1254953,1255121,1255131,1255211,1255344,1255483,1255488,1255551,1255597,1255621,1255625,1255714,1255762,1255788,1255884,1255925,1255927,1255963,1256176,1256184,1256333,1256369,1256372,1256382,1256418,1256539,1256558,1256722,1256913,1256922,1256929,1256959,1256989,1257191,1257198,1257429,1257456,1257477,1257481,1257528,1257542,1257698,1257751,1257936,1258111,1258229,1258247,1258278,1258294,1258342,1258386,1258584,1258952,1258967,1259154,1259243,1259263,1259535,1259552,1259693,1259879,1261342,1261369,1261539,1261667,6542331,1848382,1849154,1851357,1851542,1863426,1873172,1875632,1877615,1832257,1832743,1841976,1845519,1925943,1521379,1524245,1654491,1235846,1241964,2273312,2214845,3692667,3693645,3694112,3695754,3925476,3927942,3935572,3946985,1731616,1682479,1684139,1684137,1685876,1686549,7532438,7531863,7531533,2427336,3427454,3429567,3435525,3435765,3834814,3834843,3835866,3837624,3837823,3843436,5881165,7267965,2761615,2761689,2768118,2761697,2761772,7873628,2763118,7873332,7872827,7873697,2764625,7872462,7871793,2764797,7873657,2764988,7872367,2765338,7872572,7873642,7872892,2766143,7872755,7873594,2766357,2766372,7873527,2766444,7872343,7872418,7872417,7872428,7873322,7872697,7872272,2766551,2766563,7872397,7873412,7872415,2766699,2766725,7872997,2766757,2767681,2767696,2767987,7872889,2768263,7873575,7873668,2768295,2768316,7871679,7872765,7873666,7872115,7872144,2769344,7873276,7871655,7872164,7871614,7872599,2769994,7873612,7872753,7871536,7873691,7872243,2771533,7872299,2771764,7871739,2771949,7872242,2772645,2772653,7872618,2772796,2772891,7871736,7871936,2776496,7872756,7872837,2776485,2643743,1548958,2652249,2633975,3116156,6176421,2151649,2154855,2166584,6943577,2176264,2991935,2743177,2634341,2636147,2647972,2633655,2835411,2914548,2951935,2873589,2896592,2855373,2892811,2953541,2862888,2924577,2942341,2959441,2874455,6947479,2946887,2814196,2873292,2829962,2868837,2837672,2512465,3433359,2659262,2661591,2661633,2659638,2658588,2658867,2659258,2658543,2244322,2562746,3691474,3926282,3928245,3945612,3947437,3696372,3944665,3931251,3693461,3928547,3128832,2653229,3696448,6559994,1496889,2768274,2771725,2771893,2911288,2613539,2616933,2622666,2978954,2981274,2637347,2647297,2648299,2648928,2654578,3167329,3173985,3174662,3177672,3182732,6534466,6534799,6535147,6535768,6544494,1259229,2766824,3531673,5964347,2892518,2842647,5128638,2122311,2947416,3629941,3746666,6255147,6941685,6417336,3642267,3485968,1282682,3481258,3633244,3649138,5419396,5431716,5478585,5781925,5784685,3439525,3439781,3442778,1215694,1216115,1216787,1217362,1217569,1217658,1217734,1217926,1512287,1512348,1512524,1512549,1512658,1512934,1513714,1514125,3748726,3625829,8131514,3626657,3648112,3643617,1563241,1577995,1626493,1626498,6417711,1273293,1273294,3632824,1279275,3762839,1268571,1283692,6198157,6198533,1176832,1176862,1178148,1336846,1337368,1336786,1521977,1522281,1276632,7113953,1794299,3337493,1864226,1848681,1848649,1861454,1865694,2112669,1856472,1541618,2121529,8144372,1517381,1495797,7839424,3883281,3882585,7839789,2147795,2163774,3429959,7839434,2163136,2153778,2152274,7839393,2177796,2166456,7839581,7839392,2163334,3843819,3453535,3471324,6355222,7839681,3448433,6322112,4159872,4736286,4676547,4714936,4158643,4158712,7217562,4722147,4678165,4331987,4337452,4341715,4695945,5454967,5967149,5978683,5991285,5881954,5886889,6325484,6691318,6944114,5942636,5975223,5958512,6148378,5958975,6111984,6111529,6128736,3353715,3472492,3455976,3462672,3461936,3936542,3466255,3929792,3937485,3944223,3665314,1641644,1642668,1642669,1642672,1626998,3658394,3654665,1627529,2569147,1645357,3656537,1627978,3653224,3658476,1626197,3654451,3658194,1623673,1635333,3681344,6851663,2221789,3384653,2232486,2337542,3384481,3383583,3668562,2231494,2231326,1723538,2297816,1679428,7521299,1685214,1722546,1117328,1679429,1685789,7667785,1699492,1728159,2367252,8129222,3625693,2299978,2343379,3712451,3712429,3643345,3625974,3633827,3621837,3621194,3742299,1717511,1713779,2231755,3643573,1153555,1156944,3634671,6268943,3619548,1611268,1614614,2375167,7754689,1259434,1268189,7735862,2455517,6912297,2597367,2344838,3585155,3584935,2437797,6695671,7356639,7621325,1285941,2595293,1692194,1692151,3582981,3584734,3595528,3589172,1679435,2453347,2449661,1679859,2249221,2244122,1616236,1599922,2457161,3613358,3614736,3816597,2246451,1611884,8136321,3499976,3491913,3496751,3495694,2449893,1292118,1286764,2425714,1318433,1292572,1668284,1668841,1185958,1312356,1257896,1859181,1474856,1133835,1461264,1122162,1148416,1433879,1179245,1852748,2264397,1121941,4445717,5524819,1435246,1856566,1168197,2565327,5368381,1462157,4187459,4224239,4589213,4587774,4583989,1129953,1141133,1865721,1862978,6419788,1852278,1864381,1864231,1864878,4619773,1848119,2515136,6357744,4896861,5413481,5436536,5435436,6537734,8133884,6367618,2114152,6542127,2525587,5539525,2525635,5446275,2518759,5435465,2261633,5386729,5396498,8133845,2512177,5445498};

        int idCityIndex = ThreadLocalRandom.current().nextInt(0, 999);

        String url = "http://api.openweathermap.org/data/2.5/weather?id="+cityCodes[idCityIndex]+"&APPID="+apiKey;

        HttpEntity<String> requestEntity = new HttpEntity<>(headers);
        ResponseEntity<String> stringResponseEntity = restTemplate.exchange(url, HttpMethod.GET, requestEntity, String.class);
        return stringResponseEntity.getBody();
    }
}
